{"version":3,"file":"GCContentAdapter-BEcfdG0u.js","sources":["../../node_modules/@jbrowse/plugin-gccontent/esm/GCContentAdapter/GCContentAdapter.js"],"sourcesContent":["import { BaseFeatureDataAdapter, } from '@jbrowse/core/data_adapters/BaseAdapter';\nimport { firstValueFrom } from 'rxjs';\nimport { ObservableCreate } from '@jbrowse/core/util/rxjs';\nimport { SimpleFeature } from '@jbrowse/core/util';\nimport { toArray } from 'rxjs/operators';\nclass GCContentAdapter extends BaseFeatureDataAdapter {\n    constructor() {\n        super(...arguments);\n        this.gcMode = 'content';\n    }\n    async configure() {\n        var _a;\n        const adapter = await ((_a = this.getSubAdapter) === null || _a === void 0 ? void 0 : _a.call(this, this.getConf('sequenceAdapter')));\n        if (!adapter) {\n            throw new Error('Error getting subadapter');\n        }\n        return adapter.dataAdapter;\n    }\n    async getRefNames() {\n        const adapter = await this.configure();\n        return adapter.getRefNames();\n    }\n    getFeatures(query, opts) {\n        return ObservableCreate(async (observer) => {\n            var _a;\n            const sequenceAdapter = await this.configure();\n            const windowSize = this.getConf('windowSize');\n            const windowDelta = this.getConf('windowDelta');\n            const hw = windowSize === 1 ? 1 : windowSize / 2; // Half the window size\n            const f = windowSize === 1;\n            let { start: queryStart, end: queryEnd } = query;\n            queryStart = Math.max(0, queryStart - hw);\n            queryEnd += hw;\n            if (queryEnd < 0 || queryStart > queryEnd) {\n                observer.complete();\n                return;\n            }\n            const ret = sequenceAdapter.getFeatures({\n                ...query,\n                start: queryStart,\n                end: queryEnd,\n            }, opts);\n            const feats = await firstValueFrom(ret.pipe(toArray()));\n            const residues = ((_a = feats[0]) === null || _a === void 0 ? void 0 : _a.get('seq')) || '';\n            for (let i = hw; i < residues.length - hw; i += windowDelta) {\n                const r = f ? residues[i] : residues.slice(i - hw, i + hw);\n                let nc = 0;\n                let ng = 0;\n                let len = 0;\n                for (const letter of r) {\n                    if (letter === 'c' || letter === 'C') {\n                        nc++;\n                    }\n                    else if (letter === 'g' || letter === 'G') {\n                        ng++;\n                    }\n                    if (letter !== 'N') {\n                        len++;\n                    }\n                }\n                const pos = queryStart;\n                const score = this.gcMode === 'content'\n                    ? (ng + nc) / (len || 1)\n                    : this.gcMode === 'skew'\n                        ? (ng - nc) / (ng + nc || 1)\n                        : 0;\n                observer.next(new SimpleFeature({\n                    uniqueId: `${this.id}_${pos + i}`,\n                    refName: query.refName,\n                    start: pos + i,\n                    end: pos + i + windowDelta,\n                    score,\n                }));\n            }\n            observer.complete();\n        });\n    }\n    /**\n     * called to provide a hint that data tied to a certain region\n     * will not be needed for the foreseeable future and can be purged\n     * from caches, etc\n     */\n    freeResources( /* { region } */) { }\n}\nGCContentAdapter.capabilities = ['hasLocalStats'];\nexport default GCContentAdapter;\n"],"names":["GCContentAdapter","BaseFeatureDataAdapter","_a","adapter","query","opts","ObservableCreate","observer","sequenceAdapter","windowSize","windowDelta","hw","f","queryStart","queryEnd","ret","residues","firstValueFrom","toArray","i","r","nc","ng","len","letter","pos","score","SimpleFeature"],"mappings":"oEAKA,MAAMA,UAAyBC,EAAAA,sBAAuB,CAClD,aAAc,CACV,MAAM,GAAG,SAAS,EAClB,KAAK,OAAS,SACtB,CACI,MAAM,WAAY,CACd,IAAIC,EACJ,MAAMC,EAAU,OAAQD,EAAK,KAAK,iBAAmB,MAAQA,IAAO,OAAS,OAASA,EAAG,KAAK,KAAM,KAAK,QAAQ,iBAAiB,CAAC,GACnI,GAAI,CAACC,EACD,MAAM,IAAI,MAAM,0BAA0B,EAE9C,OAAOA,EAAQ,WACvB,CACI,MAAM,aAAc,CAEhB,OADgB,MAAM,KAAK,UAAW,GACvB,YAAa,CACpC,CACI,YAAYC,EAAOC,EAAM,CACrB,OAAOC,EAAiB,MAAOC,GAAa,CACxC,IAAIL,EACJ,MAAMM,EAAkB,MAAM,KAAK,UAAW,EACxCC,EAAa,KAAK,QAAQ,YAAY,EACtCC,EAAc,KAAK,QAAQ,aAAa,EACxCC,EAAKF,IAAe,EAAI,EAAIA,EAAa,EACzCG,EAAIH,IAAe,EACzB,GAAI,CAAE,MAAOI,EAAY,IAAKC,CAAU,EAAGV,EAG3C,GAFAS,EAAa,KAAK,IAAI,EAAGA,EAAaF,CAAE,EACxCG,GAAYH,EACRG,EAAW,GAAKD,EAAaC,EAAU,CACvCP,EAAS,SAAU,EACnB,MAChB,CACY,MAAMQ,EAAMP,EAAgB,YAAY,CACpC,GAAGJ,EACH,MAAOS,EACP,IAAKC,CACR,EAAET,CAAI,EAEDW,IAAad,GADL,MAAMe,EAAeF,EAAI,KAAKG,EAAO,CAAE,CAAC,GACxB,CAAC,KAAO,MAAQhB,IAAO,OAAS,OAASA,EAAG,IAAI,KAAK,IAAM,GACzF,QAASiB,EAAIR,EAAIQ,EAAIH,EAAS,OAASL,EAAIQ,GAAKT,EAAa,CACzD,MAAMU,EAAIR,EAAII,EAASG,CAAC,EAAIH,EAAS,MAAMG,EAAIR,EAAIQ,EAAIR,CAAE,EACzD,IAAIU,EAAK,EACLC,EAAK,EACLC,EAAM,EACV,UAAWC,KAAUJ,EACbI,IAAW,KAAOA,IAAW,IAC7BH,KAEKG,IAAW,KAAOA,IAAW,MAClCF,IAEAE,IAAW,KACXD,IAGR,MAAME,EAAMZ,EACNa,EAAQ,KAAK,SAAW,WACvBJ,EAAKD,IAAOE,GAAO,GACpB,KAAK,SAAW,QACXD,EAAKD,IAAOC,EAAKD,GAAM,GACxB,EACVd,EAAS,KAAK,IAAIoB,gBAAc,CAC5B,SAAU,GAAG,KAAK,EAAE,IAAIF,EAAMN,CAAC,GAC/B,QAASf,EAAM,QACf,MAAOqB,EAAMN,EACb,IAAKM,EAAMN,EAAIT,EACf,MAAAgB,CACpB,CAAiB,CAAC,CAClB,CACYnB,EAAS,SAAU,CAC/B,CAAS,CACT,CAMI,eAAiC,CAAA,CACrC,CACAP,EAAiB,aAAe,CAAC,eAAe","x_google_ignoreList":[0]}
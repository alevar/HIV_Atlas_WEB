import{bn as H,d as M,al as G,aJ as A,bo as R,ab as L,bp as V,bE as j,b1 as Q,c as Y,i as k,u as S,f as W,t as J,O as X}from"./rpcWorker-DOy5Xw-Q.js";import{c as K}from"./crc32-DYOsEsjq.js";import{A as Z}from"./AbortablePromiseCache-xs5eyOH3.js";class D{constructor(e,t){this.blockPosition=e,this.dataPosition=t}toString(){return`${this.blockPosition}:${this.dataPosition}`}compareTo(e){return this.blockPosition-e.blockPosition||this.dataPosition-e.dataPosition}static min(...e){let t,n=0;for(;!t;n+=1)t=e[n];for(;n<e.length;n+=1)t.compareTo(e[n])>0&&(t=e[n]);return t}}function E(h,e=0,t=!1){if(t)throw new Error("big-endian virtual file offsets not implemented");return new D(h[e+7]*1099511627776+h[e+6]*4294967296+h[e+5]*16777216+h[e+4]*65536+h[e+3]*256+h[e+2],h[e+1]<<8|h[e])}class ${constructor(e,t,n,r){this.minv=e,this.maxv=t,this.bin=n,this._fetchedSize=r}toUniqueString(){return`${this.minv.toString()}..${this.maxv.toString()} (bin ${this.bin}, fetchedSize ${this.fetchedSize()})`}toString(){return this.toUniqueString()}compareTo(e){return this.minv.compareTo(e.minv)||this.maxv.compareTo(e.maxv)||this.bin-e.bin}fetchedSize(){return this._fetchedSize!==void 0?this._fetchedSize:this.maxv.blockPosition+65536-this.minv.blockPosition}}function ee(h){return new Promise(e=>setTimeout(e,h))}function te(h){if(h.greaterThan(Number.MAX_SAFE_INTEGER)||h.lessThan(Number.MIN_SAFE_INTEGER))throw new Error("integer overflow");return h.toNumber()}function ne(h){if(h&&h.aborted)if(typeof DOMException>"u"){const e=new Error("aborted");throw e.code="ERR_ABORTED",e}else throw new DOMException("aborted","AbortError")}function re(h,e){return e.minv.blockPosition-h.maxv.blockPosition<65e3&&e.maxv.blockPosition-h.minv.blockPosition<5e6}function se(h={}){return"aborted"in h?{signal:h}:h}function O(h,e){const t=[];let n;if(h.length===0)return h;h.sort((r,s)=>{const a=r.minv.blockPosition-s.minv.blockPosition;return a===0?r.minv.dataPosition-s.minv.dataPosition:a});for(const r of h)(!e||r.maxv.compareTo(e)>0)&&(n===void 0?(t.push(r),n=r):re(n,r)?r.maxv.compareTo(n.maxv)>0&&(n.maxv=r.maxv):(t.push(r),n=r));return t}function U(h,e){return{lineCount:te(H.fromBytesLE(Array.prototype.slice.call(h,e,e+8),!0))}}function P(h,e){return h?h.compareTo(e)>0?e:h:e}function ie(h,e=t=>t){let t=0,n=0;const r=[],s={};for(let a=0;a<h.length;a+=1)if(!h[a]){if(n<a){let o=h.toString("utf8",n,a);o=e(o),r[t]=o,s[o]=t}n=a+1,t+=1}return{refNameToId:s,refIdToName:r}}class z{constructor({filehandle:e,renameRefSeq:t=n=>n}){this.filehandle=e,this.renameRefSeq=t}}const ae=21578050;function oe(h,e){return h-h%e}function ce(h,e){return h-h%e+e}function de(h,e){return e-=1,[[0,0],[1+(h>>26),1+(e>>26)],[9+(h>>23),9+(e>>23)],[73+(h>>20),73+(e>>20)],[585+(h>>17),585+(e>>17)],[4681+(h>>14),4681+(e>>14)]]}class v extends z{async lineCount(e,t){var n,r;return((r=(n=(await this.parse(t)).indices[e])===null||n===void 0?void 0:n.stats)===null||r===void 0?void 0:r.lineCount)||0}async _parse(e){const t=await this.filehandle.readFile(e);if(t.readUInt32LE(0)!==ae)throw new Error("Not a BAI file");const n=t.readInt32LE(4),s=((1<<(5+1)*3)-1)/7;let a=8,o;const c=new Array(n);for(let i=0;i<n;i++){const u=t.readInt32LE(a);let f;a+=4;const l={};for(let g=0;g<u;g+=1){const m=t.readUInt32LE(a);if(a+=4,m===s+1)a+=4,f=U(t,a+16),a+=32;else{if(m>s+1)throw new Error("bai index contains too many bins, please use CSI");{const p=t.readInt32LE(a);a+=4;const b=new Array(p);for(let w=0;w<p;w++){const y=E(t,a);a+=8;const I=E(t,a);a+=8,o=P(o,y),b[w]=new $(y,I,m)}l[m]=b}}}const d=t.readInt32LE(a);a+=4;const _=new Array(d);for(let g=0;g<d;g++){const m=E(t,a);a+=8,o=P(o,m),_[g]=m}c[i]={binIndex:l,linearIndex:_,stats:f}}return{bai:!0,firstDataLine:o,maxBlockSize:65536,indices:c,refCount:n}}async indexCov(e,t,n,r={}){const a=t!==void 0,c=(await this.parse(r)).indices[e];if(!c)return[];const{linearIndex:i=[],stats:u}=c;if(i.length===0)return[];const f=n===void 0?(i.length-1)*16384:ce(n,16384),l=t===void 0?0:oe(t,16384),d=a?new Array((f-l)/16384):new Array(i.length-1),_=i[i.length-1].blockPosition;if(f>(i.length-1)*16384)throw new Error("query outside of range of linear index");let g=i[l/16384].blockPosition;for(let m=l/16384,p=0;m<f/16384;m++,p++)d[p]={score:i[m+1].blockPosition-g,start:m*16384,end:m*16384+16384},g=i[m+1].blockPosition;return d.map(m=>({...m,score:m.score*((u==null?void 0:u.lineCount)||0)/_}))}async blocksForRange(e,t,n,r={}){t<0&&(t=0);const s=await this.parse(r);if(!s)return[];const a=s.indices[e];if(!a)return[];const o=de(t,n),c=[];for(const[d,_]of o)for(let g=d;g<=_;g++)if(a.binIndex[g]){const m=a.binIndex[g];for(const p of m)c.push(p)}const i=a.linearIndex.length;let u;const f=Math.min(t>>14,i-1),l=Math.min(n>>14,i-1);for(let d=f;d<=l;++d){const _=a.linearIndex[d];_&&(!u||_.compareTo(u)<0)&&(u=_)}return O(c,u)}async parse(e={}){return this.setupP||(this.setupP=this._parse(e).catch(t=>{throw this.setupP=void 0,t})),this.setupP}async hasRefSeq(e,t={}){var n;return!!(!((n=(await this.parse(t)).indices[e])===null||n===void 0)&&n.binIndex)}}const he=21582659,ue=38359875;function le(h,e){return h*2**e}function q(h,e){return Math.floor(h/2**e)}class F extends z{constructor(){super(...arguments),this.maxBinNumber=0,this.depth=0,this.minShift=0}async lineCount(e,t){var n,r;return((r=(n=(await this.parse(t)).indices[e])===null||n===void 0?void 0:n.stats)===null||r===void 0?void 0:r.lineCount)||0}async indexCov(){return[]}parseAuxData(e,t){const n=e.readInt32LE(t),r=n&65536?"zero-based-half-open":"1-based-closed",s={0:"generic",1:"SAM",2:"VCF"}[n&15];if(!s)throw new Error(`invalid Tabix preset format flags ${n}`);const a={ref:e.readInt32LE(t+4),start:e.readInt32LE(t+8),end:e.readInt32LE(t+12)},o=e.readInt32LE(t+16),c=o?String.fromCharCode(o):"",i=e.readInt32LE(t+20),u=e.readInt32LE(t+24);return{columnNumbers:a,coordinateType:r,metaValue:o,metaChar:c,skipLines:i,format:s,formatFlags:n,...ie(e.subarray(t+28,t+28+u),this.renameRefSeq)}}async _parse(e){const t=await this.filehandle.readFile(e),n=await M(t);let r;if(n.readUInt32LE(0)===he)r=1;else if(n.readUInt32LE(0)===ue)r=2;else throw new Error("Not a CSI file");this.minShift=n.readInt32LE(4),this.depth=n.readInt32LE(8),this.maxBinNumber=((1<<(this.depth+1)*3)-1)/7;const s=n.readInt32LE(12),a=s>=30?this.parseAuxData(n,16):void 0,o=n.readInt32LE(16+s);let c=16+s+4,i;const u=new Array(o);for(let f=0;f<o;f++){const l=n.readInt32LE(c);c+=4;const d={};let _;for(let g=0;g<l;g++){const m=n.readUInt32LE(c);if(c+=4,m>this.maxBinNumber)_=U(n,c+28),c+=44;else{i=P(i,E(n,c)),c+=8;const p=n.readInt32LE(c);c+=4;const b=new Array(p);for(let w=0;w<p;w+=1){const y=E(n,c);c+=8;const I=E(n,c);c+=8,i=P(i,y),b[w]=new $(y,I,m)}d[m]=b}}u[f]={binIndex:d,stats:_}}return{csiVersion:r,firstDataLine:i,indices:u,refCount:o,csi:!0,maxBlockSize:65536,...a}}async blocksForRange(e,t,n,r={}){t<0&&(t=0);const s=await this.parse(r),a=s==null?void 0:s.indices[e];if(!a)return[];const o=this.reg2bins(t,n);if(o.length===0)return[];const c=[];for(const[i,u]of o)for(let f=i;f<=u;f++)if(a.binIndex[f]){const l=a.binIndex[f];for(const d of l)c.push(d)}return O(c,new D(0,0))}reg2bins(e,t){e-=1,e<1&&(e=1),t>2**50&&(t=2**34),t-=1;let n=0,r=0,s=this.minShift+this.depth*3;const a=[];for(;n<=this.depth;s-=3,r+=le(1,n*3),n+=1){const o=r+q(e,s),c=r+q(t,s);if(c-o+a.length>this.maxBinNumber)throw new Error(`query ${e}-${t} is too large for current binning scheme (shift ${this.minShift}, depth ${this.depth}), try a smaller query or a coarser index binning scheme`);a.push([o,c])}return a}async parse(e={}){return this.setupP||(this.setupP=this._parse(e).catch(t=>{throw this.setupP=void 0,t})),this.setupP}async hasRefSeq(e,t={}){var n;return!!(!((n=(await this.parse(t)).indices[e])===null||n===void 0)&&n.binIndex)}}var x={BAM_FPAIRED:1,BAM_FPROPER_PAIR:2,BAM_FUNMAP:4,BAM_FMUNMAP:8,BAM_FREVERSE:16,BAM_FMREVERSE:32,BAM_FREAD1:64,BAM_FREAD2:128,BAM_FSECONDARY:256,BAM_FQCFAIL:512,BAM_FDUP:1024,BAM_FSUPPLEMENTARY:2048};const B="=ACMGRSVTWYHKDBN".split(""),C="MIDNSHP=X???????".split("");class fe{constructor(e){this.data={},this._tagList=[],this._allTagsParsed=!1;const{bytes:t,fileOffset:n}=e,{byteArray:r,start:s}=t;this.data={start:r.readInt32LE(s+8)},this.bytes=t,this._id=n,this._refID=r.readInt32LE(s+4),this.flags=(r.readInt32LE(s+16)&4294901760)>>16}get(e){return this[e]?this.data[e]?this.data[e]:(this.data[e]=this[e](),this.data[e]):this._get(e.toLowerCase())}end(){return this.get("start")+this.get("length_on_ref")}seq_id(){return this._refID}_get(e){return e in this.data?this.data[e]:(this.data[e]=this._parseTag(e),this.data[e])}_tags(){this._parseAllTags();let e=["seq"];this.isSegmentUnmapped()||e.push("start","end","strand","score","qual","MQ","CIGAR","length_on_ref","template_length"),this.isPaired()&&e.push("next_segment_position","pair_orientation"),e=e.concat(this._tagList||[]);for(const n of Object.keys(this.data))!n.startsWith("_")&&n!=="next_seq_id"&&e.push(n);const t={};return e.filter(n=>{if(n in this.data&&this.data[n]===void 0||n==="CG"||n==="cg")return!1;const r=n.toLowerCase(),s=t[r];return t[r]=!0,!s})}parent(){}children(){return this.get("subfeatures")}id(){return this._id}mq(){const e=(this.get("_bin_mq_nl")&65280)>>8;return e===255?void 0:e}score(){return this.get("mq")}qual(){var e;return(e=this.qualRaw())===null||e===void 0?void 0:e.join(" ")}qualRaw(){if(this.isSegmentUnmapped())return;const{start:e,byteArray:t}=this.bytes,n=e+36+this.get("_l_read_name")+this.get("_n_cigar_op")*4+this.get("_seq_bytes"),r=this.get("seq_length");return t.subarray(n,n+r)}strand(){return this.isReverseComplemented()?-1:1}multi_segment_next_segment_strand(){if(!this.isMateUnmapped())return this.isMateReverseComplemented()?-1:1}name(){return this.get("_read_name")}_read_name(){const e=this.get("_l_read_name"),{byteArray:t,start:n}=this.bytes;return t.toString("ascii",n+36,n+36+e-1)}_parseTag(e){if(this._allTagsParsed)return;const{byteArray:t,start:n}=this.bytes;let r=this._tagOffset||n+36+this.get("_l_read_name")+this.get("_n_cigar_op")*4+this.get("_seq_bytes")+this.get("seq_length");const s=this.bytes.end;let a;for(;r<s&&a!==e;){const o=String.fromCharCode(t[r],t[r+1]);a=o.toLowerCase();const c=String.fromCharCode(t[r+2]);r+=3;let i;switch(c){case"A":{i=String.fromCharCode(t[r]),r+=1;break}case"i":{i=t.readInt32LE(r),r+=4;break}case"I":{i=t.readUInt32LE(r),r+=4;break}case"c":{i=t.readInt8(r),r+=1;break}case"C":{i=t.readUInt8(r),r+=1;break}case"s":{i=t.readInt16LE(r),r+=2;break}case"S":{i=t.readUInt16LE(r),r+=2;break}case"f":{i=t.readFloatLE(r),r+=4;break}case"Z":case"H":{for(i="";r<=s;){const u=t[r++];if(u===0)break;i+=String.fromCharCode(u)}break}case"B":{i="";const u=t[r++],f=String.fromCharCode(u),l=t.readInt32LE(r);if(r+=4,f==="i")if(o==="CG")for(let d=0;d<l;d++){const _=t.readInt32LE(r),g=_>>4,m=C[_&15];i+=g+m,r+=4}else for(let d=0;d<l;d++)i+=t.readInt32LE(r),d+1<l&&(i+=","),r+=4;if(f==="I")if(o==="CG")for(let d=0;d<l;d++){const _=t.readUInt32LE(r),g=_>>4,m=C[_&15];i+=g+m,r+=4}else for(let d=0;d<l;d++)i+=t.readUInt32LE(r),d+1<l&&(i+=","),r+=4;if(f==="s")for(let d=0;d<l;d++)i+=t.readInt16LE(r),d+1<l&&(i+=","),r+=2;if(f==="S")for(let d=0;d<l;d++)i+=t.readUInt16LE(r),d+1<l&&(i+=","),r+=2;if(f==="c")for(let d=0;d<l;d++)i+=t.readInt8(r),d+1<l&&(i+=","),r+=1;if(f==="C")for(let d=0;d<l;d++)i+=t.readUInt8(r),d+1<l&&(i+=","),r+=1;if(f==="f")for(let d=0;d<l;d++)i+=t.readFloatLE(r),d+1<l&&(i+=","),r+=4;break}default:console.warn(`Unknown BAM tag type '${c}', tags may be incomplete`),i=void 0,r=s}if(this._tagOffset=r,this._tagList.push(o),a===e)return i;this.data[a]=i}this._allTagsParsed=!0}_parseAllTags(){this._parseTag("")}_parseCigar(e){return e.match(/\d+\D/g).map(t=>[/\D/.exec(t)[0].toUpperCase(),Number.parseInt(t,10)])}isPaired(){return!!(this.flags&x.BAM_FPAIRED)}isProperlyPaired(){return!!(this.flags&x.BAM_FPROPER_PAIR)}isSegmentUnmapped(){return!!(this.flags&x.BAM_FUNMAP)}isMateUnmapped(){return!!(this.flags&x.BAM_FMUNMAP)}isReverseComplemented(){return!!(this.flags&x.BAM_FREVERSE)}isMateReverseComplemented(){return!!(this.flags&x.BAM_FMREVERSE)}isRead1(){return!!(this.flags&x.BAM_FREAD1)}isRead2(){return!!(this.flags&x.BAM_FREAD2)}isSecondary(){return!!(this.flags&x.BAM_FSECONDARY)}isFailedQc(){return!!(this.flags&x.BAM_FQCFAIL)}isDuplicate(){return!!(this.flags&x.BAM_FDUP)}isSupplementary(){return!!(this.flags&x.BAM_FSUPPLEMENTARY)}cigar(){if(this.isSegmentUnmapped())return;const{byteArray:e,start:t}=this.bytes,n=this.get("_n_cigar_op");let r=t+36+this.get("_l_read_name");const s=this.get("seq_length");let a="",o=0,c=e.readInt32LE(r),i=c>>4,u=C[c&15];if(u==="S"&&i===s)return r+=4,c=e.readInt32LE(r),i=c>>4,u=C[c&15],u!=="N"&&console.warn("CG tag with no N tag"),this.data.length_on_ref=i,this.get("CG");for(let f=0;f<n;++f)c=e.readInt32LE(r),i=c>>4,u=C[c&15],a+=i+u,u!=="H"&&u!=="S"&&u!=="I"&&(o+=i),r+=4;return this.data.length_on_ref=o,a}length_on_ref(){return this.data.length_on_ref?this.data.length_on_ref:(this.get("cigar"),this.data.length_on_ref)}_n_cigar_op(){return this.get("_flag_nc")&65535}_l_read_name(){return this.get("_bin_mq_nl")&255}_seq_bytes(){return this.get("seq_length")+1>>1}getReadBases(){return this.seq()}seq(){const{byteArray:e,start:t}=this.bytes,n=t+36+this.get("_l_read_name")+this.get("_n_cigar_op")*4,r=this.get("_seq_bytes"),s=this.get("seq_length");let a="",o=0;for(let c=0;c<r;++c){const i=e[n+c];a+=B[(i&240)>>4],o++,o<s&&(a+=B[i&15],o++)}return a}getPairOrientation(){if(!this.isSegmentUnmapped()&&!this.isMateUnmapped()&&this._refID===this._next_refid()){const e=this.isReverseComplemented()?"R":"F",t=this.isMateReverseComplemented()?"R":"F";let n=" ",r=" ";this.isRead1()?(n="1",r="2"):this.isRead2()&&(n="2",r="1");const s=[];return this.template_length()>0?(s[0]=e,s[1]=n,s[2]=t,s[3]=r):(s[2]=e,s[3]=n,s[0]=t,s[1]=r),s.join("")}return""}_bin_mq_nl(){return this.bytes.byteArray.readInt32LE(this.bytes.start+12)}_flag_nc(){return this.bytes.byteArray.readInt32LE(this.bytes.start+16)}seq_length(){return this.bytes.byteArray.readInt32LE(this.bytes.start+20)}_next_refid(){return this.bytes.byteArray.readInt32LE(this.bytes.start+24)}_next_pos(){return this.bytes.byteArray.readInt32LE(this.bytes.start+28)}template_length(){return this.bytes.byteArray.readInt32LE(this.bytes.start+32)}toJSON(){const e={};for(const t of Object.keys(this))t.startsWith("_")||t==="bytes"||(e[t]=this[t]);return e}}function ge(h){const e=h.split(/\r?\n/),t=[];for(const n of e){const[r,...s]=n.split(/\t/);r&&t.push({tag:r.slice(1),data:s.map(a=>{const o=a.indexOf(":"),c=a.slice(0,o),i=a.slice(o+1);return{tag:c,value:i}})})}return t}const me=21840194,N=65536;async function _e(h){let e=[];for await(const t of h)e=e.concat(t);return e}class pe{read(){throw new Error("never called")}stat(){throw new Error("never called")}readFile(){throw new Error("never called")}close(){throw new Error("never called")}}class be{constructor({bamFilehandle:e,bamPath:t,bamUrl:n,baiPath:r,baiFilehandle:s,baiUrl:a,csiPath:o,csiFilehandle:c,csiUrl:i,htsget:u,yieldThreadTime:f=100,renameRefSeqs:l=d=>d}){if(this.htsget=!1,this.featureCache=new Z({cache:new G({maxSize:50}),fill:async(d,_)=>{const{chunk:g,opts:m}=d,{data:p,cpositions:b,dpositions:w}=await this._readChunk({chunk:g,opts:{...m,signal:_}});return this.readBamFeatures(p,b,w,g)}}),this.renameRefSeq=l,e)this.bam=e;else if(t)this.bam=new A(t);else if(n)this.bam=new R(n);else if(u)this.htsget=!0,this.bam=new pe;else throw new Error("unable to initialize bam");if(c)this.index=new F({filehandle:c});else if(o)this.index=new F({filehandle:new A(o)});else if(i)this.index=new F({filehandle:new R(i)});else if(s)this.index=new v({filehandle:s});else if(r)this.index=new v({filehandle:new A(r)});else if(a)this.index=new v({filehandle:new R(a)});else if(t)this.index=new v({filehandle:new A(`${t}.bai`)});else if(n)this.index=new v({filehandle:new R(`${n}.bai`)});else if(u)this.htsget=!0;else throw new Error("unable to infer index format");this.yieldThreadTime=f}async getHeaderPre(e){const t=se(e);if(!this.index)return;const n=await this.index.parse(t),r=n.firstDataLine?n.firstDataLine.blockPosition+65535:void 0;let s;if(r){const u=r+N,f=await this.bam.read(L.Buffer.alloc(u),0,u,0,t);if(!f.bytesRead)throw new Error("Error reading header");s=f.buffer.subarray(0,Math.min(f.bytesRead,r))}else s=await this.bam.readFile(t);const a=await M(s);if(a.readInt32LE(0)!==me)throw new Error("Not a BAM file");const o=a.readInt32LE(4);this.header=a.toString("utf8",8,8+o);const{chrToIndex:c,indexToChr:i}=await this._readRefSeqs(o+8,65535,t);return this.chrToIndex=c,this.indexToChr=i,ge(this.header)}getHeader(e){return this.headerP||(this.headerP=this.getHeaderPre(e).catch(t=>{throw this.headerP=void 0,t})),this.headerP}async getHeaderText(e={}){return await this.getHeader(e),this.header}async _readRefSeqs(e,t,n){if(e>t)return this._readRefSeqs(e,t*2,n);const r=t+N,{bytesRead:s,buffer:a}=await this.bam.read(L.Buffer.alloc(r),0,t,0,n);if(!s)throw new Error("Error reading refseqs from header");const o=await M(a.subarray(0,Math.min(s,t))),c=o.readInt32LE(e);let i=e+4;const u={},f=[];for(let l=0;l<c;l+=1){const d=o.readInt32LE(i),_=this.renameRefSeq(o.toString("utf8",i+4,i+4+d-1)),g=o.readInt32LE(i+d+4);if(u[_]=l,f.push({refName:_,length:g}),i=i+8+d,i>o.length)return console.warn(`BAM header is very big.  Re-fetching ${t} bytes.`),this._readRefSeqs(e,t*2,n)}return{chrToIndex:u,indexToChr:f}}async getRecordsForRange(e,t,n,r){return _e(this.streamRecordsForRange(e,t,n,r))}async*streamRecordsForRange(e,t,n,r){var s;await this.getHeader(r);const a=(s=this.chrToIndex)===null||s===void 0?void 0:s[e];if(a===void 0||!this.index)yield[];else{const o=await this.index.blocksForRange(a,t-1,n,r);yield*this._fetchChunkFeatures(o,a,t,n,r)}}async*_fetchChunkFeatures(e,t,n,r,s={}){const{viewAsPairs:a}=s,o=[];let c=!1;for(const i of e){const u=await this.featureCache.get(i.toString(),{chunk:i,opts:s},s.signal),f=[];for(const l of u)if(l.seq_id()===t)if(l.get("start")>=r){c=!0;break}else l.get("end")>=n&&f.push(l);if(o.push(f),yield f,c)break}ne(s.signal),a&&(yield this.fetchPairs(t,o,s))}async fetchPairs(e,t,n){const{pairAcrossChr:r,maxInsertSize:s=2e5}=n,a={},o={};t.map(l=>{const d={};for(const _ of l){const g=_.name(),m=_.id();d[g]||(d[g]=0),d[g]++,o[m]=1}for(const[_,g]of Object.entries(d))g===1&&(a[_]=!0)});const c=[];t.map(l=>{for(const d of l){const _=d.name(),g=d.get("start"),m=d._next_pos(),p=d._next_refid();this.index&&a[_]&&(r||p===e&&Math.abs(g-m)<s)&&c.push(this.index.blocksForRange(p,m,m+1,n))}});const i=new Map,u=await Promise.all(c);for(const l of u.flat())i.has(l.toString())||i.set(l.toString(),l);return(await Promise.all([...i.values()].map(async l=>{const{data:d,cpositions:_,dpositions:g,chunk:m}=await this._readChunk({chunk:l,opts:n}),p=[];for(const b of await this.readBamFeatures(d,_,g,m))a[b.get("name")]&&!o[b.id()]&&p.push(b);return p}))).flat()}async _readRegion(e,t,n={}){const{bytesRead:r,buffer:s}=await this.bam.read(L.Buffer.alloc(t),0,t,e,n);return s.subarray(0,Math.min(r,t))}async _readChunk({chunk:e,opts:t}){const n=await this._readRegion(e.minv.blockPosition,e.fetchedSize(),t),{buffer:r,cpositions:s,dpositions:a}=await V(n,e);return{data:r,cpositions:s,dpositions:a,chunk:e}}async readBamFeatures(e,t,n,r){let s=0;const a=[];let o=0,c=+Date.now();for(;s+4<e.length;){const i=e.readInt32LE(s),u=s+4+i-1;if(n){for(;s+r.minv.dataPosition>=n[o++];);o--}if(u<e.length){const f=new fe({bytes:{byteArray:e,start:s,end:u},fileOffset:t.length>0?t[o]*256+(s-n[o])+r.minv.dataPosition+1:K.signed(e.slice(s,u))});a.push(f),this.yieldThreadTime&&+Date.now()-c>this.yieldThreadTime&&(await ee(1),c=+Date.now())}s=u+1}return a}async hasRefSeq(e){var t,n;const r=(t=this.chrToIndex)===null||t===void 0?void 0:t[e];return r===void 0?!1:(n=this.index)===null||n===void 0?void 0:n.hasRefSeq(r)}async lineCount(e){var t;const n=(t=this.chrToIndex)===null||t===void 0?void 0:t[e];return n===void 0||!this.index?0:this.index.lineCount(n)}async indexCov(e,t,n){var r;if(!this.index)return[];await this.index.parse();const s=(r=this.chrToIndex)===null||r===void 0?void 0:r[e];return s===void 0?[]:this.index.indexCov(s,t,n)}async blocksForRange(e,t,n,r){var s;if(!this.index)return[];await this.index.parse();const a=(s=this.chrToIndex)===null||s===void 0?void 0:s[e];return a===void 0?[]:this.index.blocksForRange(a,t,n,r)}}class T{constructor(e,t,n){this.record=e,this.adapter=t,this.ref=n}_get_name(){return this.record.get("name")}_get_type(){return"match"}_get_score(){return this.record.get("mq")}_get_flags(){return this.record.flags}_get_strand(){return this.record.isReverseComplemented()?-1:1}_get_pair_orientation(){return this.record.isPaired()?this.record.getPairOrientation():void 0}_get_next_ref(){return this.record.isPaired()?this.adapter.refIdToName(this.record._next_refid()):void 0}_get_next_pos(){return this.record.isPaired()?this.record._next_pos():void 0}_get_next_segment_position(){return this.record.isPaired()?`${this.adapter.refIdToName(this.record._next_refid())}:${this.record._next_pos()+1}`:void 0}_get_seq(){return this.record.getReadBases()}qualRaw(){return this.record.qualRaw()}set(){}tags(){const e=Object.getOwnPropertyNames(T.prototype);return[...new Set(e.filter(t=>t.startsWith("_get_")&&t!=="_get_mismatches"&&t!=="_get_tags").map(t=>t.replace("_get_","")).concat(this.record._tags()))]}id(){return`${this.adapter.id}-${this.record.id()}`}get(e){const t=`_get_${e}`;return this[t]?this[t]():this.record.get(e)}_get_refName(){return this.adapter.refIdToName(this.record.seq_id())}parent(){}children(){}pairedFeature(){return!1}toJSON(){return{...Object.fromEntries(this.tags().map(e=>[e,this.get(e)]).filter(e=>e[1]!==void 0)),uniqueId:this.id()}}_get_mismatches(){return j(this.get("CIGAR"),this.get("MD"),this.get("seq"),this.ref,this.qualRaw())}_get_clipPos(){const e=this.get("CIGAR")||"";return Q(e,this.get("strand"))}}class we extends Y.BaseFeatureDataAdapter{async configurePre(){const e=this.getConf("bamLocation"),t=this.getConf(["index","location"]),n=this.getConf(["index","indexType"]),r=this.pluginManager,s=n==="CSI",a=new be({bamFilehandle:k.openLocation(e,r),csiFilehandle:s?k.openLocation(t,r):void 0,baiFilehandle:s?void 0:k.openLocation(t,r),yieldThreadTime:Number.POSITIVE_INFINITY}),o=this.getConf("sequenceAdapter");if(o&&this.getSubAdapter){const{dataAdapter:c}=await this.getSubAdapter(o);return{bam:a,sequenceAdapter:c}}return{bam:a}}async configure(){return this.configureP||(this.configureP=this.configurePre().catch(e=>{throw this.configureP=void 0,e})),this.configureP}async getHeader(e){const{bam:t}=await this.configure();return t.getHeaderText(e)}async setupPre(e){const{statusCallback:t=()=>{}}=e||{},{bam:n}=await this.configure();return this.samHeader=await S.updateStatus("Downloading index",t,async()=>{const r=await n.getHeader(e),s=[],a={};return r==null||r.filter(o=>o.tag==="SQ").forEach((o,c)=>{const i=o.data.find(u=>u.tag==="SN");if(i){const u=i.value;a[u]=c,s[c]=u}}),{idToName:s,nameToId:a}}),this.samHeader}async setup(e){return this.setupP||(this.setupP=this.setupPre(e).catch(t=>{throw this.setupP=void 0,t})),this.setupP}async getRefNames(e){const{idToName:t}=await this.setup(e);return t}async seqFetch(e,t,n){const{sequenceAdapter:r}=await this.configure(),s=r;if(!s||!e)return;const a=s.getFeatures({refName:e,start:t,end:n,assemblyName:""}),o=await W(a.pipe(J()));let c="";if(o.sort((i,u)=>i.get("start")-u.get("start")).forEach(i=>{const u=i.get("start"),f=i.get("end"),l=Math.max(t-u,0),_=Math.min(n-u,f-u)-l,g=i.get("seq")||i.get("residues");c+=g.slice(l,l+_)}),c.length!==n-t)throw new Error(`sequence fetch failed: fetching ${e}:${(t-1).toLocaleString()}-${n.toLocaleString()} returned ${c.length.toLocaleString()} bases, but should have returned ${(n-t).toLocaleString()}`);return c}getFeatures(e,t){const{refName:n,start:r,end:s,originalRefName:a}=e,{signal:o,filterBy:c,statusCallback:i=()=>{}}=t||{};return X(async u=>{const{bam:f}=await this.configure();await this.setup(t);const l=await S.updateStatus("Downloading alignments",i,()=>f.getRecordsForRange(n,r,s,t));await S.updateStatus("Processing alignments",i,async()=>{const{flagInclude:d=0,flagExclude:_=0,tagFilter:g,readName:m}=c||{};for(const p of l){let b;p.get("MD")||(b=await this.seqFetch(a||n,p.get("start"),p.get("end")));const w=p.flags;if(!((w&d)!==d&&!(w&_))){if(g){const y=p.get(g.tag),I=g.value;if(I==="*"?y!==void 0:`${y}`!=`${I}`)continue}m&&p.get("name")!==m||u.next(new T(p,this,b))}}u.complete()})},o)}async getMultiRegionFeatureDensityStats(e,t){const{bam:n}=await this.configure();if(n.index){const r=await S.bytesForRegions(e,n),s=this.getConf("fetchSizeLimit");return{bytes:r,fetchSizeLimit:s}}return super.getMultiRegionFeatureDensityStats(e,t)}freeResources(){}refIdToName(e){var t;return(t=this.samHeader)===null||t===void 0?void 0:t.idToName[e]}}var Ee=Object.freeze({__proto__:null,default:we});export{be as B,me as a,we as b,Ee as c,ge as p};
//# sourceMappingURL=BamAdapter-VsihUO9e.js.map

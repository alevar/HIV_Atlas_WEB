{"version":3,"file":"GetSequenceDialog-nnh9fJEU.js","sources":["../../node_modules/@jbrowse/core/util/formatFastaStrings.js","../../node_modules/@mui/icons-material/GetApp.js","../../node_modules/@jbrowse/plugin-linear-genome-view/esm/LinearGenomeView/components/GetSequenceDialog.js"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.formatFastaLines = formatFastaLines;\nexports.formatSeqFasta = formatSeqFasta;\n/**\n * Returns sequence with new line every 80 characters\n * ref https://stackoverflow.com/a/51506718/2129219\n *\n * @param seqString -  string\n * @returns formatted sequence string\n */\nfunction formatFastaLines(seqString) {\n    return seqString.replaceAll(/(.{1,80})/g, '$1\\n').trimEnd();\n}\n/**\n * Formats the sequences chunks into Fasta format\n *\n * @param chunks - array of seq chunks of the form `{ header: string, seq: string }`\n * @returns formatted sequence in fasta format\n */\nfunction formatSeqFasta(chunks) {\n    return chunks\n        .map(chunk => `>${chunk.header}\\n${formatFastaLines(chunk.seq)}`)\n        .join('\\n');\n}\n","\"use strict\";\n\"use client\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.default = void 0;\nvar _createSvgIcon = _interopRequireDefault(require(\"./utils/createSvgIcon\"));\nvar _jsxRuntime = require(\"react/jsx-runtime\");\nvar _default = exports.default = (0, _createSvgIcon.default)( /*#__PURE__*/(0, _jsxRuntime.jsx)(\"path\", {\n  d: \"M19 9h-4V3H9v6H5l7 7zM5 18v2h14v-2z\"\n}), 'GetApp');","import React, { useEffect, useState } from 'react';\nimport { makeStyles } from 'tss-react/mui';\nimport { Button, Checkbox, CircularProgress, Container, DialogActions, DialogContent, FormGroup, FormControlLabel, TextField, Typography, } from '@mui/material';\nimport { observer } from 'mobx-react';\nimport { saveAs } from 'file-saver';\nimport { getConf } from '@jbrowse/core/configuration';\nimport copy from 'copy-to-clipboard';\nimport { Dialog } from '@jbrowse/core/ui';\nimport { getSession, reverse, complement, } from '@jbrowse/core/util';\nimport { formatSeqFasta } from '@jbrowse/core/util/formatFastaStrings';\n// icons\nimport { ContentCopy as ContentCopyIcon } from '@jbrowse/core/ui/Icons';\nimport GetAppIcon from '@mui/icons-material/GetApp';\nconst useStyles = makeStyles()({\n    dialogContent: {\n        width: '80em',\n    },\n    textAreaFont: {\n        fontFamily: 'Courier New',\n    },\n});\n/**\n * Fetches and returns a list features for a given list of regions\n */\nasync function fetchSequence(model, regions, signal) {\n    const session = getSession(model);\n    const { leftOffset, rightOffset } = model;\n    if (!leftOffset || !rightOffset) {\n        throw new Error('no offsets on model to use for range');\n    }\n    if (leftOffset.assemblyName !== rightOffset.assemblyName) {\n        throw new Error('not able to fetch sequences from multiple assemblies');\n    }\n    const { rpcManager, assemblyManager } = session;\n    const assemblyName = leftOffset.assemblyName || rightOffset.assemblyName || '';\n    const assembly = assemblyManager.get(assemblyName);\n    if (!assembly) {\n        throw new Error(`assembly ${assemblyName} not found`);\n    }\n    const adapterConfig = getConf(assembly, ['sequence', 'adapter']);\n    const sessionId = 'getSequence';\n    return rpcManager.call(sessionId, 'CoreGetFeatures', {\n        adapterConfig,\n        regions,\n        sessionId,\n        signal,\n    });\n}\nconst GetSequenceDialog = observer(function ({ model, handleClose, }) {\n    const { classes } = useStyles();\n    const [error, setError] = useState();\n    const [sequenceChunks, setSequenceChunks] = useState();\n    const [rev, setReverse] = useState(false);\n    const [copied, setCopied] = useState(false);\n    const [comp, setComplement] = useState(false);\n    const { leftOffset, rightOffset } = model;\n    const loading = Boolean(sequenceChunks === undefined);\n    useEffect(() => {\n        const controller = new AbortController();\n        (async () => {\n            try {\n                // random note: the current selected region can't be a computed because\n                // it uses action on base1dview even though it's on the ephemeral\n                // base1dview\n                const selection = model.getSelectedRegions(leftOffset, rightOffset);\n                if (selection.length === 0) {\n                    throw new Error('Selected region is out of bounds');\n                }\n                const chunks = await fetchSequence(model, selection, controller.signal);\n                setSequenceChunks(chunks);\n            }\n            catch (e) {\n                console.error(e);\n                setError(e);\n            }\n        })();\n        return () => {\n            controller.abort();\n        };\n    }, [model, leftOffset, rightOffset]);\n    const sequence = sequenceChunks\n        ? formatSeqFasta(sequenceChunks.map(chunk => {\n            let chunkSeq = chunk.get('seq');\n            const chunkRefName = chunk.get('refName');\n            const chunkStart = chunk.get('start') + 1;\n            const chunkEnd = chunk.get('end');\n            const loc = `${chunkRefName}:${chunkStart}-${chunkEnd}`;\n            if ((chunkSeq === null || chunkSeq === void 0 ? void 0 : chunkSeq.length) !== chunkEnd - chunkStart + 1) {\n                throw new Error(`${loc} returned ${chunkSeq.length.toLocaleString()} bases, but should have returned ${(chunkEnd - chunkStart).toLocaleString()}`);\n            }\n            if (rev) {\n                chunkSeq = reverse(chunkSeq);\n            }\n            if (comp) {\n                chunkSeq = complement(chunkSeq);\n            }\n            return {\n                header: loc + (rev ? '-rev' : '') + (comp ? '-comp' : ''),\n                seq: chunkSeq,\n            };\n        }))\n        : '';\n    const sequenceTooLarge = sequence ? sequence.length > 1000000 : false;\n    return (React.createElement(Dialog, { maxWidth: \"xl\", open: true, onClose: () => {\n            handleClose();\n            model.setOffsets();\n        }, title: \"Reference sequence\" },\n        React.createElement(DialogContent, null,\n            error ? (React.createElement(Typography, { color: \"error\" }, `${error}`)) : loading ? (React.createElement(Container, null,\n                \"Retrieving reference sequence...\",\n                React.createElement(CircularProgress, { style: { marginLeft: 10 }, size: 20, disableShrink: true }))) : null,\n            React.createElement(TextField, { \"data-testid\": \"rubberband-sequence\", variant: \"outlined\", multiline: true, minRows: 5, maxRows: 10, disabled: sequenceTooLarge, className: classes.dialogContent, fullWidth: true, value: sequenceTooLarge\n                    ? 'Reference sequence too large to display, use the download FASTA button'\n                    : sequence, InputProps: {\n                    readOnly: true,\n                    classes: {\n                        input: classes.textAreaFont,\n                    },\n                } }),\n            React.createElement(FormGroup, null,\n                React.createElement(FormControlLabel, { control: React.createElement(Checkbox, { value: rev, onChange: event => {\n                            setReverse(event.target.checked);\n                        } }), label: \"Reverse sequence\" }),\n                React.createElement(FormControlLabel, { control: React.createElement(Checkbox, { value: comp, onChange: event => {\n                            setComplement(event.target.checked);\n                        } }), label: \"Complement sequence\" })),\n            React.createElement(Typography, { style: { margin: 10 } }, \"Note: Check both boxes for the \\\"reverse complement\\\"\")),\n        React.createElement(DialogActions, null,\n            React.createElement(Button, { onClick: () => {\n                    copy(sequence);\n                    setCopied(true);\n                    setTimeout(() => {\n                        setCopied(false);\n                    }, 500);\n                }, disabled: loading || !!error || sequenceTooLarge, color: \"primary\", startIcon: React.createElement(ContentCopyIcon, null) }, copied ? 'Copied' : 'Copy to clipboard'),\n            React.createElement(Button, { onClick: () => {\n                    saveAs(new Blob([sequence || ''], {\n                        type: 'text/x-fasta;charset=utf-8',\n                    }), 'jbrowse_ref_seq.fa');\n                }, disabled: loading || !!error, color: \"primary\", startIcon: React.createElement(GetAppIcon, null) }, \"Download FASTA\"),\n            React.createElement(Button, { onClick: handleClose, variant: \"contained\" }, \"Close\"))));\n});\nexport default GetSequenceDialog;\n"],"names":["formatFastaStrings","formatFastaLines","formatSeqFasta_1","formatSeqFasta","seqString","chunks","chunk","_interopRequireDefault","require$$0","GetApp","default_1","_createSvgIcon","require$$1","_jsxRuntime","require$$2","useStyles","makeStyles","fetchSequence","model","regions","signal","session","getSession","leftOffset","rightOffset","rpcManager","assemblyManager","assemblyName","assembly","adapterConfig","getConf","sessionId","GetSequenceDialog","observer","handleClose","classes","error","setError","useState","sequenceChunks","setSequenceChunks","rev","setReverse","copied","setCopied","comp","setComplement","loading","useEffect","controller","selection","e","sequence","chunkSeq","chunkRefName","chunkStart","chunkEnd","loc","reverse","complement","sequenceTooLarge","React","Dialog","DialogContent","Typography","Container","CircularProgress","TextField","FormGroup","FormControlLabel","Checkbox","event","DialogActions","Button","copy","ContentCopyIcon","saveAs","GetAppIcon"],"mappings":"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","x_google_ignoreList":[0,1,2]}
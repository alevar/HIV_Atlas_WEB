import{u as R,aZ as k,l as H,bK as z,aC as $,aB as Q,bL as X,aD as v,b0 as G,aE as J,aF as K,c as Z}from"./index-CYW4W05g.js";function B(t,e,o,a,h,c,n){e+a<0||e>c||(n&&(t.fillStyle=n),t.fillRect(e,o,a,h))}function E(t){const{bases:e}=t.palette;return{A:e.A.main,C:e.C.main,G:e.G.main,T:e.T.main,deletion:"#808080"}}function U(t){return Object.fromEntries(Object.entries(E(t)).map(([e,o])=>[e,t.palette.getContrastText(o)]))}function V(t){return["methylation","modifications"].includes(t||"")}function Y(){return!0}function F(){const t=R.measureText("A"),e=R.measureText("M")-2;return{charWidth:t,charHeight:e}}function W(t){return t.get("is_paired")&&t.get("refName")!==t.get("next_ref")?"#555":`hsl(${Math.abs(t.get("template_length"))/10},50%,50%)`}function tt(t){return`hsl(${t.get("score")},50%,50%)`}function et(t,e){const o=H.readConfObject(e,"orientationType"),h=z[o][t.get("pair_orientation")];return{LR:"color_pair_lr",RR:"color_pair_rr",RL:"color_pair_rl",LL:"color_pair_ll"}[h]}function ot(t){return t.get("strand")===-1?"#8F8FD8":"#EC8B8B"}function nt(t,e){return k[et(t,e)||"color_nostrand"]}function st(t){const e=t.get("flags"),o=t.get("strand");if(e&1){const a=e&64?-1:1;return e&2?o*a===1?"color_rev_strand":"color_fwd_strand":e&8?o*a===1?"color_rev_missing_mate":"color_fwd_missing_mate":t.get("refName")===t.get("next_ref")?o*a===1?"color_rev_strand_not_proper":"color_fwd_strand_not_proper":o===1?"color_fwd_diff_chr":"color_rev_diff_chr"}return"color_unknown"}function rt(t){return k[st(t)]}function it({colorType:t,tag:e,feature:o,config:a,defaultColor:h,colorTagMap:c}){switch(t){case"insertSize":return W(o);case"strand":return ot(o);case"mappingQuality":return tt(o);case"pairOrientation":return nt(o,a);case"stranded":return rt(o);case"xs":case"tag":{const n=o.get("tags"),p=n?n[e]:o.get(e);return e==="XS"||e==="TS"?p==="-"?k.color_rev_strand:p==="+"?k.color_fwd_strand:k.color_nostrand:e==="ts"?p==="-"?o.get("strand")===-1?k.color_fwd_strand:k.color_rev_strand:p==="+"?o.get("strand")===-1?k.color_rev_strand:k.color_fwd_strand:k.color_nostrand:c[p]||k.color_nostrand}case"insertSizeAndPairOrientation":break;case"modifications":case"methylation":return o.get("flags")&16?"#c8dcc8":"#c8c8c8";default:return h?"lightgrey":H.readConfObject(a,"color",{feature:o})}}function lt({ctx:t,feat:e,renderArgs:o}){const{regions:a,bpPerPx:h}=o,{heightPx:c,topPx:n,feature:p}=e,S=a[0],y=p.get("start"),l=p.get("end"),[m,b]=R.bpSpanPx(y,l,S,h),g=S.reversed?-1:1,M=p.get("strand")*g;h<10&&c>5?M===-1?(t.beginPath(),t.moveTo(m-5,n+c/2),t.lineTo(m,n+c),t.lineTo(b,n+c),t.lineTo(b,n),t.lineTo(m,n),t.closePath(),t.fill()):(t.beginPath(),t.moveTo(m,n),t.lineTo(m,n+c),t.lineTo(b,n+c),t.lineTo(b+5,n+c/2),t.lineTo(b,n),t.closePath(),t.fill()):t.fillRect(m,n,b-m,c)}function at({ctx:t,feat:e,region:o,bpPerPx:a,canvasWidth:h}){const{feature:c,topPx:n,heightPx:p}=e,y=(c.get("qual")||"").split(" ").map(r=>+r),l=$(c.get("CIGAR")),m=1/a,b=c.get("start");let g=0,M=0;for(let r=0;r<l.length;r+=2){const i=+l[r],u=l[r+1];if(u==="S"||u==="I")g+=i;else if(u==="D"||u==="N")M+=i;else if(u==="M"||u==="X"||u==="="){for(let d=0;d<i;d++){const f=y[g+d],x=b+M+d,T=R.bpSpanPx(x,x+1,o,a)[0],_=`hsl(${f===255?150:f*1.5},55%,50%)`;B(t,T,n,m+.5,p,h,_)}g+=i,M+=i}}}function ct({ctx:t,feat:e,region:o,bpPerPx:a,colorForBase:h,contrastForBase:c,charWidth:n,charHeight:p,canvasWidth:S}){const y=p-2,{feature:l,topPx:m,heightPx:b}=e,g=l.get("seq"),M=$(l.get("CIGAR")),r=1/a,i=l.get("start");let u=0,d=0;if(g)for(let f=0;f<M.length;f+=2){const x=+M[f],T=M[f+1];if(T==="S"||T==="I")u+=x;else if(T==="D"||T==="N")d+=x;else if(T==="M"||T==="X"||T==="="){for(let _=0;_<x;_++){const w=g[u+_],s=i+d+_,[q]=R.bpSpanPx(s,s+1,o,a),L=h[w];B(t,q,m,r+.5,b,S,L),r>=n&&b>=y&&(t.fillStyle=c[w],t.fillText(w,q+(r-n)/2+1,m+b))}u+=x,d+=x}}}function ft({ctx:t,feat:e,region:o,bpPerPx:a,renderArgs:h,canvasWidth:c}){const{feature:n,topPx:p,heightPx:S}=e,{modificationTagMap:y={}}=h,l=n.get("seq");if(!l)return;const m=Q(n,"MM","Mm")||"",b=n.get("CIGAR"),g=n.get("start"),M=n.get("strand"),r=$(b),i=X(n),u=v(m,l,M);let d=0;for(const{type:f,positions:x}of u){const T=y[f]||"black",_=G.colord(T);for(const w of J(r,x)){const s=g+w,[q,L]=R.bpSpanPx(s,s+1,o,a),I=(i==null?void 0:i[d])||0,C=I!==1?_.alpha(I+.1).toHslString():T,j=L-q+.5;B(t,q,p,j,S,c,C),d++}}}function pt({ctx:t,feat:e,region:o,bpPerPx:a,renderArgs:h,canvasWidth:c}){var n,p;const{regionSequence:S}=h,{feature:y,topPx:l,heightPx:m}=e;if(!S)throw new Error("region sequence required for methylation");if(!y.get("seq"))return;const g=y.get("start"),M=y.get("end"),{methBins:r,methProbs:i}=K(y);function u(d){if(r[d]){const f=i[d]||0;return(f>.5?G.colord("red").alpha((f-.5)*2):G.colord("blue").alpha(1-f*2)).toHslString()}}for(let d=0;d<M-g;d++){const f=d+g,x=(n=S[f-o.start+1])===null||n===void 0?void 0:n.toLowerCase(),T=(p=S[f-o.start+2])===null||p===void 0?void 0:p.toLowerCase();if(x==="c"&&T==="g")if(a>2){const[_,w]=R.bpSpanPx(f,f+2,o,a),s=w-_+.5,q=u(d)||u(d+1)||"blue";B(t,_,l,s,m,c,q)}else{const[_,w]=R.bpSpanPx(f,f+1,o,a),s=w-_+.5,q=u(d)||"blue";B(t,_,l,s,m,c,q);const[L,I]=R.bpSpanPx(f+1,f+2,o,a),C=I-L+.5,j=u(d+1)||"blue";B(t,L,l,C,m,c,j)}}}function gt({ctx:t,feat:e,renderArgs:o,colorForBase:a,contrastForBase:h,charWidth:c,charHeight:n,defaultColor:p,canvasWidth:S}){const{config:y,bpPerPx:l,regions:m,colorBy:b,colorTagMap:g={}}=o,{tag:M="",type:r=""}=b||{},{feature:i}=e,u=m[0];switch(t.fillStyle=it({feature:i,config:y,tag:M,defaultColor:p,colorType:r,colorTagMap:g}),lt({ctx:t,feat:e,renderArgs:o}),r){case"perBaseQuality":at({ctx:t,feat:e,region:u,bpPerPx:l,canvasWidth:S});break;case"perBaseLettering":ct({ctx:t,feat:e,region:u,bpPerPx:l,colorForBase:a,contrastForBase:h,charWidth:c,charHeight:n,canvasWidth:S});break;case"modifications":ft({ctx:t,feat:e,region:u,bpPerPx:l,renderArgs:o,canvasWidth:S});break;case"methylation":pt({ctx:t,feat:e,region:u,bpPerPx:l,renderArgs:o,canvasWidth:S});break}}function ut({ctx:t,feat:e,renderArgs:o,minSubfeatureWidth:a,largeInsertionIndicatorScale:h,mismatchAlpha:c,charWidth:n,charHeight:p,colorForBase:S,contrastForBase:y,canvasWidth:l,drawSNPsMuted:m,drawIndels:b=!0}){const{bpPerPx:g,regions:M}=o,{heightPx:r,topPx:i,feature:u}=e,d=M[0],f=u.get("start"),x=Math.min(1/g,2),T=u.get("mismatches"),_=p-2,w=d.reversed?1/g+1:-1;if(T){for(const s of T){const q=f+s.start,L=s.length,I=s.base,[C,j]=R.bpSpanPx(q,q+L,d,g),O=Math.max(a,Math.abs(C-j));if(s.type==="mismatch"){if(!m){const P=S[s.base]||"#888",D=c?s.qual===void 0?P:G.colord(P).alpha(Math.min(1,s.qual/50)).toHslString():P;B(t,Math.round(C),i,O,r,l,D)}if(O>=n&&r>=_){const P=m?"black":y[s.base]||"black";t.fillStyle=c?s.qual===void 0?P:G.colord(P).alpha(Math.min(1,s.qual/50)).toHslString():P,t.fillText(I,C+(O-n)/2+1,i+r)}}else if(s.type==="deletion"&&b){B(t,C,i,Math.abs(C-j),r,l,S.deletion);const P=`${s.length}`,D=R.measureText(P,10);O>=D&&r>=_&&(t.fillStyle=y.deletion,t.fillText(P,(C+j)/2-D/2,i+r))}else if(s.type==="insertion"&&b){t.fillStyle="purple";const P=C+w,D=+s.base||s.length,A=Math.max(0,Math.min(1.2,1/g));if(D<10&&(B(t,P,i,A,r,l,"purple"),1/g>=n&&r>=_)){const N=P-A;B(t,N,i,A*3,1,l),B(t,N,i+r-1,A*3,1,l),t.fillText(`(${s.base})`,P+3,i+r)}}else if(s.type==="hardclip"||s.type==="softclip"){const P=C+w,D=s.type==="hardclip"?"red":"blue",A=Math.max(a,x);if(B(t,P,i,A,r,l,D),1/g>=n&&r>=_){const N=P-A;B(t,N,i,A*3,1,l),B(t,N,i+r-1,A*3,1,l),t.fillText(`(${s.base})`,P+3,i+r)}}else if(s.type==="skip"&&C+O>0){const P=O-(g>10?1.5:0);t.clearRect(C,i,P,r),B(t,Math.max(0,C),i+r/2-1,P+Math.min(C,0),2,l,"#333")}}if(b)for(const s of T){const q=f+s.start,L=s.length,[I]=R.bpSpanPx(q,q+L,d,g),C=+s.base||s.length,j=`${C}`;if(s.type==="insertion"&&C>=10)if(g>h)B(t,I-1,i,2,r,l,"purple");else if(r>p){const O=R.measureText(j),P=5;B(t,I-O/2-P,i,O+2*P,r,l,"purple"),t.fillStyle="white",t.fillText(j,I-O/2,i+r)}else B(t,I-2,i,2*2,r,l,"purple")}}}function dt({ctx:t,feat:e,renderArgs:o,config:a,theme:h,colorForBase:c,canvasWidth:n}){const{feature:p,topPx:S,heightPx:y}=e,{regions:l,bpPerPx:m}=o,b=l[0],g=H.readConfObject(a,"minSubfeatureWidth"),M=p.get("mismatches"),r=p.get("seq"),{charWidth:i,charHeight:u}=F();if(!(r&&M))return;const d=u-2,f=$(p.get("CIGAR"));let x=0,T=0;for(let _=0;_<f.length;_+=2){const w=f[_+1],s=+f[_];if(w==="S"){for(let q=0;q<s;q++){const L=r[x+q],I=p.get("start")-(_===0?s:0)+T+q,[C,j]=R.bpSpanPx(I,I+1,b,m),O=Math.max(g,j-C),P=c[L]||"#000000";t.fillStyle=P,B(t,C,S,O,y,n),O>=i&&y>=d&&(t.fillStyle=h.palette.getContrastText(P),t.fillText(L,C+(O-i)/2+1,S+y))}x+=s}w==="N"&&(T+=s),(w==="M"||w==="="||w==="X")&&(T+=s,x+=s),w==="D"&&(T+=s),w==="I"&&(x+=s)}}function mt({ctx:t,layoutRecords:e,canvasWidth:o,renderArgs:a}){const{config:h,showSoftClip:c,colorBy:n,theme:p}=a,S=H.readConfObject(h,"mismatchAlpha"),y=H.readConfObject(h,"minSubfeatureWidth"),l=H.readConfObject(h,"largeInsertionIndicatorScale"),m=H.readConfObject(h,"color")==="#f0f",b=Z.createJBrowseTheme(p),g=E(b),M=U(b);t.font="bold 10px Courier New,monospace";const{charWidth:r,charHeight:i}=F(),u=V(n==null?void 0:n.type),d=Y();for(const f of e)gt({ctx:t,feat:f,renderArgs:a,defaultColor:m,colorForBase:g,contrastForBase:M,charWidth:r,charHeight:i,canvasWidth:o}),ut({ctx:t,feat:f,renderArgs:a,mismatchAlpha:S,drawSNPsMuted:u,drawIndels:d,largeInsertionIndicatorScale:l,minSubfeatureWidth:y,charWidth:r,charHeight:i,colorForBase:g,contrastForBase:M,canvasWidth:o}),c&&dt({ctx:t,feat:f,renderArgs:a,colorForBase:g,config:h,theme:b,canvasWidth:o})}export{mt as makeImageData};
//# sourceMappingURL=makeImageData-DYvD3cTh.js.map
